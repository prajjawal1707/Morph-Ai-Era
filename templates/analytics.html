<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MORPH-AI-ERA â€¢ Analytics</title>

    <!-- Icons & Plotly -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-K25LC6ESHG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-K25LC6ESHG');
    </script>

    <style>
        :root {
            --bg: #0f1115;
            --panel: #1b1f2a;
            --panel-2: #111521;
            --muted: #9aa4b2;
            --text: #e7ecf3;
            --brand: #1E90FF;
            --accent: #00e676;
            --danger: #ff5252;
            --radius: 14px;
        }

        * {
            box-sizing: border-box;
        }


        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, Apple Color Emoji, Segoe UI Emoji;
        }

        /* --- LAYOUT ESSENTIALS --- */
        .wrap {
            display: flex;
            min-height: 100dvh;
        }

        /* --- SIDEBAR (Restored from your snippet) --- */
        .sidebar {
            position: sticky;
            top: 0;
            left: 0;
            height: 100vh;
            width: 70px;
            background: var(--panel-2);
            border-right: 1px solid #202533;
            padding: 14px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: width 0.25s ease;
            z-index: 10;
            overflow: hidden;
        }

        .sidebar.expanded {
            width: 220px;
            align-items: flex-start;
        }

        .brand {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            height: 44px;
            border-radius: 12px;
            background: #0c1a33;
            border: 1px solid #1b2a44;
            color: var(--brand);
            font-weight: 700;
            margin-bottom: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .brand span {
            margin-left: 10px;
            font-size: 18px;
            white-space: nowrap;
            display: none;
        }

        .sidebar.expanded .brand span {
            display: inline;
        }

        .sidebar .spacer {
            flex-grow: 1;
        }

        .nav {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            flex-shrink: 0;
        }

        .navbtn {
            width: 100%;
            height: 44px;
            border-radius: 12px;
            border: 1px solid #1e2534;
            background: #0e1422;
            color: #a9b3c3;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 12px;
            cursor: pointer;
            text-decoration: none;
        }

        .navbtn span {
            display: none;
            white-space: nowrap;
        }

        .sidebar.expanded .navbtn span {
            display: inline;
        }

        .auth-status {
            display: none;
            padding: 15px;
            margin-top: 15px;
            border-top: 1px solid #202533;
        }

        .sidebar.expanded .auth-status {
            display: block;
        }

        #userStatus {
            font-size: 13px;
            color: var(--muted);
            margin: 0 0 10px 0;
            white-space: nowrap;
        }

        #authLinks a {
            color: var(--brand);
            text-decoration: none;
            font-size: 14px;
            margin-right: 15px;
            font-weight: 500;
        }

        #mobile-toggle {
            position: fixed;
            top: 14px;
            left: 10px;
            z-index: 1001;
            display: none;
            /* Hidden by default */
        }

        /* Main Content */
        .main {
            flex: 1;
            padding-left: 24px;
            padding-right: 24px;
            overflow-x: hidden;
        }





        /* --- HEADER LAYOUT --- */
        .header {
            display: flex;
            flex-direction: column;
            /* Stacks the two rows vertically */
            gap: 10px;

            width: 100%;
        }

        /* Common style for both rows to push items to edges */
        .header-top,
        .header-bottom {
            display: flex;
            justify-content: space-between;
            /* Title/Subtitle Left, Health/Buttons Right */
            align-items: center;
            width: 100%;
        }

        .header-top {
            margin-top: 20px;
        }

        /* --- TYPOGRAPHY --- */
        .title {
            margin: 0;
            font-size: 32px;
            font-weight: 800;
            color: #cfe5ff;
            letter-spacing: -0.5px;
            /* Removed padding-left: 40px to align with subtitle, add back if needed */
        }

        .subtitle {
            font-size: 12px;
            color: #666;
            margin-top: 0;
            /* Reset margin */
        }

        /* --- CONTROLS & BUTTONS --- */
        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* --- HEALTH CARD (Your existing code) --- */
        .health-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background-color: #0c1018;
            border: 1px solid #263048;
            border-radius: 12px;
            padding: 0 16px;
            height: 48px;
            cursor: default;
            transition: all 0.3s ease;
            width: 120px;
        }

        .health-card:hover {
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(52, 221, 140, 0.1);
        }

        .health-icon {
            font-size: 20px;
            color: var(--accent);
            display: flex;
            align-items: center;
        }

        .health-label {
            font-size: 9px;
            text-transform: uppercase;
            color: #666;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .health-value {
            font-size: 20px;
            font-weight: 800;
            color: var(--text);
            line-height: 1;
        }

        /* --- RESPONSIVE (Mobile) --- */
        @media (max-width: 768px) {

            .header-top,
            .header-bottom {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .health-card,
            .controls {
                width: 100%;
                /* Full width on mobile */
                justify-content: flex-start;
            }
        }



        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 8px;
            color: var(--muted);
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #000;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 11px;
            font-weight: normal;
            pointer-events: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* AI Narrative Box */
        .ai-box {
            background: linear-gradient(135deg, #1b1f2a 0%, #16243d 100%);
            border: 1px solid var(--brand);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.5s ease;
        }

        .ai-box::before {
            content: "AI ANALYSIS";
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 10px;
            font-weight: bold;
            color: var(--brand);
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .ai-text {
            font-size: 16px;
            line-height: 1.6;
            color: #e1e8f0;
            font-family: 'Georgia', serif;
            font-style: italic;
        }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 18px;
            margin-top: 18px;
        }

        @media (min-width: 1024px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .card {
            background: linear-gradient(180deg, var(--panel), var(--panel-2));
            border: 1px solid #212735;
            border-radius: var(--radius);
            padding: 18px 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel .head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            color: #cfd8e6;
            /* font-size: 14px; */
            font-weight: 700;
            border-bottom: 1px solid #252b3b;
            padding-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .select,
        .btn,
        input[type="number"] {
            height: 36px;
            border-radius: 8px;
            border: 1px solid #263048;
            background: #12192b;
            color: #e6edf6;
            padding: 0 12px;
            font-size: 13px;
            outline: none;
        }

        .select:focus {
            border-color: var(--brand);
        }

        .btn {
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            font-weight: 500;
        }

        .btn:hover {
            background: #232d42;
        }

        .btn.primary {
            background-color: var(--brand);
            color: #fff;
            border: none;
        }

        .btn.primary:hover {
            background-color: #167bd8;
        }

        .btn.magic {
            background: linear-gradient(90deg, #1E90FF, #8A2BE2);
            color: white;
            border: none;
        }

        .calc-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .group-label {
            width: 100%;
            font-size: 11px;
            text-transform: uppercase;
            color: var(--muted);
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .plot {
            width: 100%;
            height: 380px;
            position: relative;
        }

        .placeholder-text {
            display: flex;
            height: 100%;
            align-items: center;
            justify-content: center;
            color: #555;
            font-style: italic;
            /* font-size: 13px; */
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            text-align: center;
        }

        .kpi-card {
            background: #131720;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #222938;
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
        }

        .kpi-label {
            font-size: 0.85rem;
            color: var(--muted);
            margin-top: 5px;
            text-transform: uppercase;
        }

        /* Scenario Slider */
        .scenario-control {
            width: 100%;
            padding: 10px;
            background: #131720;
            border-radius: 8px;
            border: 1px solid #222938;
            margin-bottom: 10px;
        }


        .slider-head {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 8px;
        }

        input[type=range] {
            width: 100%;
            accent-color: var(--brand);
            cursor: pointer;
            height: 4px;
            background: #333;
            border-radius: 2px;
            border: none;
        }

        /* Tables */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .stats-table th,
        .stats-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #252b3b;
        }

        .stats-table th {
            color: var(--muted);
            font-weight: 600;
            background: #161a23;
        }




        @media (max-width: 768px) {
            #mobile-toggle {
                display: flex;
            }

            .wrap {
                display: block;
            }

            .sidebar {
                position: fixed;
                width: 220px;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                align-items: flex-start;
            }

            .sidebar.is-open {
                transform: translateX(0);
            }

            .sidebar.is-open .brand span,
            .sidebar.is-open .navbtn span {
                display: inline;
            }

            .sidebar.is-open .auth-status {
                display: block;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>

<body>
    <div id="mobile-toggle" class="brand">MAE</div>
    <div id="mobile-toggle" class="brand">MAE</div>
    <div class="wrap">
        <aside class="sidebar" id="sidebar">
            <div class="brand" id="toggleSidebar">MAE <span>MORPH-AI-ERA</span></div>
            <nav class="nav">
                <a href="/dashboard" class="navbtn"><i class="fa-solid fa-gauge-high"></i><span>Dashboard</span></a>
                <a href="/analytics" class="navbtn"><i class="fa-solid fa-chart-line"></i><span>Analytics</span></a>
                <a href="/history" class="navbtn"><i class="fa-regular fa-clock"></i><span>History</span></a>
            </nav>
            <div class="spacer"></div>
            <nav class="nav">
                <a href="/settings" class="navbtn" style="text-decoration: none;"><i
                        class="fa-solid fa-gear"></i><span>Settings</span></a>
                <a href="/profile" class="navbtn" style="text-decoration: none;"><i
                        class="fa-regular fa-user"></i><span>Profile</span>
                </a>
            </nav>
            <div class="auth-status">
                <p id="userStatus">Loading status...</p>
                <div id="authLinks"></div>
            </div>
        </aside>

        <main class="main" id="main-content">
            <div class="header">
                <div class="header-top">
                    <h1 class="title">Data Analytics</h1>

                    <div class="health-card">
                        <div class="health-icon"><i class="fa-solid fa-heart-pulse"></i></div>
                        <div>
                            <div class="health-label">DATA HEALTH</div>
                            <div class="health-value" id="health-score">--%</div>
                        </div>
                    </div>
                </div>
                <div class="header-bottom">
                    <div class="subtitle">Automated Insights & Anomaly Detection</div>
                    <div class="controls">
                        <button id="btn-generate-ai" class="btn magic">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>&nbsp; AI Summary
                        </button>
                        <button id="btn-download-pdf" class="btn primary">
                            <i class="fa-solid fa-download"></i>&nbsp; Export
                        </button>
                    </div>
                </div>
            </div>

            <div class="ai-box" id="ai-container" style="display:none;">
                <div id="ai-text" class="ai-text">Running analysis...</div>
            </div>

            <div class="grid" style="margin-top:15px;">

                <div class="card panel">
                    <div class="head"><span>Analysis Toolkit</span></div>

                    <div class="calc-group">
                        <div class="group-label">Preparation</div>
                        <button id="btn-clean-data" class="btn">Handle Missing Data</button>
                        <button id="btn-time-intelligence" class="btn">Process Dates</button>
                    </div>

                    <div class="calc-group">
                        <div class="group-label">Financial Metrics</div>
                        <button id="calc-profit-margin" class="btn">Profit Margin</button>
                        <button id="calc-cogs" class="btn">Calc COGS</button>
                        <!-- <button id="calc-moving-avg" class="btn">Moving Avg</button> -->
                    </div>

                    <div class="calc-group">
                        <div class="group-label">Advanced / AI</div>
                        <button id="btn-forecast" class="btn magic" title="Requires Date & Sales">Forecast (3
                            Mo)</button>
                        <button id="btn-cluster" class="btn magic" title="Requires Sales & Profit">Cluster
                            Segments</button>
                        <!-- <button id="calc-pareto" class="btn">Pareto Analysis</button> -->
                    </div>
                </div>

                <div class="card panel">
                    <div class="head"><span>Live KPIs & Scenario Planning</span></div>

                    <div class="scenario-control">
                        <div class="slider-head">
                            <span "What-If" Price Increase</span>
                            <span id="scenario-val" style="color:var(--brand); font-weight:bold;">0%</span>
                        </div>
                        <input type="range" id="price-slider" min="-20" max="20" value="0" step="1">
                        <div style="font-size:10px; color:#666; margin-top:4px;">Simulates impact on Projected Profit
                        </div>
                    </div>

                    <div id="kpi-panel" class="kpi-container"></div>
                </div>
            </div>

            <div class="card panel" style="margin-top:18px;">
                <div class="head"><span>Global Filters</span></div>
                <div class="controls" id="global-filters"></div>
            </div>

            <div class="grid">

                <div class="card panel">
                    <div class="head">
                        <span Trend, Seasonality & Anomalies</span>
                    </div>
                    <div id="trend-plot" class="plot"></div>
                </div>

                <div class="card panel" id="map-card">
                    <div class="head">
                        <span Geospatial Intelligence</span>
                    </div>
                    <div id="map-plot" class="plot">
                        <div class="placeholder-text">Load data with "Country" column to view map</div>
                    </div>
                </div>

                <div class="card panel">
                    <div class="head"><span>Customer Segmentation</span></div>
                    <div id="cluster-plot" class="plot"></div>
                </div>

                <div class="card panel">
                    <div class="head">
                        <span Flow Analysis</span>
                        <div class="controls">
                            <select id="sankey-source" class="select" style="width:90px;"></select>
                            <span style="font-size:12px; color:#666;">to</span>
                            <select id="sankey-target" class="select" style="width:90px;"></select>
                        </div>
                    </div>
                    <div id="sankey-plot" class="plot"></div>
                </div>

                <div class="card panel">
                    <div class="head">
                        <span Key Drivers (Correlations > 0.3)</span>
                    </div>
                    <div id="correlation-plot" class="plot"></div>
                </div>

                <div class="card panel">
                    <div class="head">
                        <span Category Drill-Down</span>
                        <select id="group-by-cat" class="select"></select>
                    </div>
                    <div id="groupby-plot" class="plot"></div>
                </div>
            </div>

            <div class="card panel" style="margin-top:18px;"> 
                <div class="head"><span>Detailed Statistics</span></div>
                <div style="overflow-x: auto; max-height: 250px;">
                    <table id="stats-table-export" class="stats-table">
                        <thead id="stats-head"></thead>
                        <tbody id="stats-body"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>


    <script>
        // --- Globals ---
        const $ = q => document.querySelector(q);
        const $$ = q => document.querySelectorAll(q);
        let ORIGINAL_DATASET = [];
        let DATASET = [];
        let HEADERS = [];
        let AVAILABLE_METRICS = { numeric: [], categorical: [] };



        function setupSidebar() {
            const sidebar = document.getElementById('sidebar');
            const desktopToggle = document.getElementById('toggleSidebar');
            const mobileToggle = document.getElementById('mobile-toggle');

            desktopToggle.addEventListener('click', () => {
                if (window.innerWidth > 768) {
                    sidebar.classList.toggle('expanded');
                } else {
                    sidebar.classList.remove('is-open');
                }
            });

            mobileToggle.addEventListener('click', () => {
                sidebar.classList.toggle('is-open');
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && sidebar.classList.contains('is-open')) {
                    if (!sidebar.contains(e.target) && e.target !== mobileToggle) {
                        sidebar.classList.remove('is-open');
                    }
                }
            });

            sidebar.querySelectorAll('.navbtn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('is-open');
                    }
                });
            });
        }

        function checkLoginStatus() {
            const authLinksDiv = document.getElementById('authLinks');
            const userStatusP = document.getElementById('userStatus');
            const isLoggedIn = false;
            const username = "DemoUser";

            if (isLoggedIn) {
                userStatusP.textContent = `Logged in as: ${username}`;
                authLinksDiv.innerHTML = `<a href="#">Log Out</a>`;
            } else {
                userStatusP.textContent = 'Using as: Guest';
                authLinksDiv.innerHTML = `<a href="#">Login</a> <a href="#">Sign Up</a>`;
            }
        }


        // --- Plotly Theme ---
        const plotlyLayout = (title) => ({
            title: { text: title, font: { size: 13, color: '#9aa4b2' }, x: 0.05 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            margin: { l: 30, r: 20, t: 40, b: 30 },
            xaxis: { gridcolor: '#1d2738', zerolinecolor: '#1d2738', tickfont: { color: '#666', size: 11 } },
            yaxis: { gridcolor: '#1d2738', zerolinecolor: '#1d2738', tickfont: { color: '#666', size: 11 } },
            showlegend: true,
            legend: { orientation: 'h', y: -0.15, font: { color: '#888', size: 11 } },
            font: { family: 'sans-serif' }
        });

        // --- Core Pipeline (The "On-Load" Magic) ---
        function runDataPipeline() {
            // 1. Clean Data (Fill Zeros)
            ORIGINAL_DATASET.forEach(r => {
                Object.keys(r).forEach(k => {
                    if (typeof r[k] === 'number' && isNaN(r[k])) r[k] = 0;
                    if (r[k] === null || r[k] === undefined) r[k] = 0;
                });
            });

            // 2. Time Intelligence (Extract Year/Month)
            if (HEADERS.includes('Date')) {
                const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                ORIGINAL_DATASET.forEach(r => {
                    const d = new Date(r.Date);
                    if (!isNaN(d)) {
                        r.Year = d.getFullYear();
                        r.MonthNum = d.getMonth(); // 0-11
                        r.Month = months[d.getMonth()];
                    }
                });
                if (!HEADERS.includes('Year')) HEADERS.push('Year', 'Month', 'MonthNum');
            }

            // 3. Financials (Margins/COGS)
            if (HEADERS.includes('Sales') && HEADERS.includes('Profit')) {
                ORIGINAL_DATASET.forEach(r => {
                    r.Profit_Margin = r.Sales !== 0 ? (r.Profit / r.Sales) * 100 : 0;
                    r.COGS = r.Sales - r.Profit;
                });
                if (!HEADERS.includes('Profit_Margin')) HEADERS.push('Profit_Margin', 'COGS');
            }

            // 4. Sync & Refresh
            DATASET = [...ORIGINAL_DATASET];
            updateMetrics();
            populateControls();
            refreshDashboard();
        }

        function updateMetrics() {
            if (DATASET.length > 0) {
                AVAILABLE_METRICS.numeric = HEADERS.filter(h => typeof DATASET[0][h] === 'number');
                AVAILABLE_METRICS.categorical = HEADERS.filter(h => typeof DATASET[0][h] === 'string');
            }
        }

        // --- Visualizations ---

        // 1. Trend + Anomaly + Seasonality
        function drawTrend() {
            const timeCol = HEADERS.includes('Date') ? 'Date' : (HEADERS.includes('Year') ? 'Year' : null);
            if (!timeCol || !HEADERS.includes('Sales')) return showMsg('trend-plot', 'Need Date & Sales');

            // Aggregate by Time
            const timeMap = new Map();
            DATASET.forEach(r => {
                const t = r[timeCol];
                timeMap.set(t, (timeMap.get(t) || 0) + (r.Sales || 0));
            });

            // Sort chronological
            const sortedTimes = [...timeMap.keys()].sort((a, b) => new Date(a) - new Date(b));
            const values = sortedTimes.map(t => timeMap.get(t));

            // A. Anomaly Detection (Z-Score)
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const stdDev = Math.sqrt(values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length);
            const anomalies = { x: [], y: [] };

            values.forEach((v, i) => {
                if (Math.abs(v - mean) > 2 * stdDev) { // > 2 Sigma
                    anomalies.x.push(sortedTimes[i]);
                    anomalies.y.push(v);
                }
            });

            // B. Seasonal Forecast (Simplified)
            // Calc linear trend
            const n = values.length;
            const idx = values.map((_, i) => i);
            const sumX = idx.reduce((a, b) => a + b, 0), sumY = values.reduce((a, b) => a + b, 0);
            const sumXY = idx.reduce((a, b, i) => a + (b * values[i]), 0), sumXX = idx.reduce((a, b) => a + (b * b), 0);
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            const futureX = [sortedTimes[n - 1], 'Forecast 1', 'Forecast 2', 'Forecast 3'];
            const futureY = [values[n - 1], slope * n + intercept, slope * (n + 1) + intercept, slope * (n + 2) + intercept];

            // Plot
            const traceLine = { x: sortedTimes, y: values, type: 'scatter', mode: 'lines', name: 'Revenue', line: { color: '#1E90FF', width: 2 } };
            const traceAnomaly = { x: anomalies.x, y: anomalies.y, type: 'scatter', mode: 'markers', name: 'Anomaly', marker: { color: '#ff5252', size: 8, symbol: 'x' } };
            const traceForecast = { x: futureX, y: futureY, type: 'scatter', mode: 'lines', name: 'Forecast', line: { color: '#00e676', dash: 'dot' } };

            Plotly.newPlot('trend-plot', [traceLine, traceAnomaly, traceForecast], plotlyLayout('Sales Trend & Anomalies'), { responsive: true });
        }

        // 2. Geospatial (Map)
        function drawMap() {
            const geoCol = HEADERS.find(h => ['Country', 'State', 'Region'].includes(h));
            const hasSales = HEADERS.includes('Sales');

            if (!geoCol || !hasSales) {
                return showMsg('map-plot', 'Requires "Country" or "State" column');
            }

            const mapData = {};
            DATASET.forEach(r => {
                const loc = r[geoCol];
                mapData[loc] = (mapData[loc] || 0) + r.Sales;
            });

            const locations = Object.keys(mapData);
            const z = Object.values(mapData);

            const data = [{
                type: 'scattergeo',
                mode: 'markers',
                locations: locations,
                locationmode: 'country names', // Works best for Countries
                marker: {
                    size: z.map(v => Math.sqrt(v) / 5), // Scale bubble
                    color: z,
                    colorscale: 'Viridis',
                    cmin: 0,
                    line: { color: 'white', width: 0.5 }
                },
                text: z.map(v => `$${v.toLocaleString()}`),
                name: 'Sales'
            }];

            Plotly.newPlot('map-plot', data, {
                ...plotlyLayout('Geospatial Sales Volume'),
                geo: {
                    bgcolor: 'transparent',
                    showland: true,
                    landcolor: '#1b1f2a',
                    showocean: true,
                    oceancolor: '#0f1115',
                    showlakes: false,
                    projection: { type: 'natural earth' }
                }
            }, { responsive: true });
        }

        // 3. Cluster Analysis
        function drawCluster() {
            if (!HEADERS.includes('Sales') || !HEADERS.includes('Profit')) return showMsg('cluster-plot', 'Need Sales & Profit');

            const points = DATASET.map(d => ({ x: d.Sales, y: d.Profit }));
            // Simple Centroid Logic
            const sorted = [...points].sort((a, b) => a.x - b.x);
            if (sorted.length < 3) return; // Not enough data

            let centroids = [sorted[0], sorted[Math.floor(sorted.length / 2)], sorted[sorted.length - 1]];

            const clusters = points.map(p => {
                const dists = centroids.map(c => Math.sqrt(Math.pow(p.x - c.x, 2) + Math.pow(p.y - c.y, 2)));
                return dists.indexOf(Math.min(...dists));
            });

            const colors = clusters.map(c => c === 0 ? '#ff5252' : (c === 1 ? '#ffb74d' : '#00e676'));
            const labels = clusters.map(c => c === 0 ? 'Low Value' : (c === 1 ? 'Medium' : 'High Value'));

            const trace = {
                x: points.map(p => p.x), y: points.map(p => p.y),
                mode: 'markers', marker: { color: colors, size: 8, opacity: 0.8 },
                text: labels, hoverinfo: 'x+y+text', name: 'Customers'
            };

            Plotly.newPlot('cluster-plot', [trace], { ...plotlyLayout('Segmentation'), xaxis: { title: 'Sales' }, yaxis: { title: 'Profit' } }, { responsive: true });
        }

        // 4. Sankey Flow
        function drawSankey() {
            const src = $('#sankey-source').value;
            const tgt = $('#sankey-target').value;
            if (!src || !tgt) return;

            const sources = [...new Set(DATASET.map(d => d[src]))];
            const targets = [...new Set(DATASET.map(d => d[tgt]))];
            const nodes = [...sources, ...targets];

            const links = [];
            sources.forEach((s, sIdx) => {
                targets.forEach((t, tIdx) => {
                    const val = DATASET.filter(d => d[src] === s && d[tgt] === t).reduce((a, b) => a + (b.Sales || 1), 0);
                    if (val > 0) links.push({ source: sIdx, target: sources.length + tIdx, value: val });
                });
            });

            Plotly.newPlot('sankey-plot', [{
                type: "sankey", orientation: "h",
                node: { pad: 15, thickness: 20, line: { color: "black", width: 0.5 }, label: nodes, color: "#1E90FF" },
                link: { source: links.map(l => l.source), target: links.map(l => l.target), value: links.map(l => l.value), color: "rgba(255, 255, 255, 0.1)" }
            }], { ...plotlyLayout('Flow Dynamics'), font: { size: 10, color: "#ccc" } }, { responsive: true });
        }

        // 5. Correlation (Filtered)
        function drawCorrelation() {
            if (AVAILABLE_METRICS.numeric.length < 2) return showMsg('correlation-plot', 'Need numeric data');
            const cols = AVAILABLE_METRICS.numeric;
            const matrix = [];

            for (let i = 0; i < cols.length; i++) {
                const row = [];
                for (let j = 0; j < cols.length; j++) {
                    if (i === j) { row.push(1); continue; }
                    const x = DATASET.map(r => r[cols[i]]), y = DATASET.map(r => r[cols[j]]), n = x.length;
                    const mx = x.reduce((a, b) => a + b, 0) / n, my = y.reduce((a, b) => a + b, 0) / n;
                    const sx = Math.sqrt(x.map(v => Math.pow(v - mx, 2)).reduce((a, b) => a + b) / n);
                    const sy = Math.sqrt(y.map(v => Math.pow(v - my, 2)).reduce((a, b) => a + b) / n);
                    let val = (sx * sy) === 0 ? 0 : (x.map((v, k) => (v - mx) * (y[k] - my)).reduce((a, b) => a + b) / n) / (sx * sy);

                    // CLEANUP: Hide weak correlations
                    if (Math.abs(val) < 0.3) val = null;
                    row.push(val);
                }
                matrix.push(row);
            }

            Plotly.newPlot('correlation-plot', [{
                z: matrix, x: cols, y: cols, type: 'heatmap', colorscale: 'RdBu', zmid: 0, showscale: true
            }], plotlyLayout('Strong Correlations'), { responsive: true });
        }

        // 6. Drill-Through Bar
        function drawDrill() {
            const cat = $('#group-by-cat').value;
            if (!cat) return;
            const groups = {};
            DATASET.forEach(r => groups[r[cat]] = (groups[r[cat]] || 0) + (r.Sales || 0));
            const x = Object.keys(groups), y = Object.values(groups);

            Plotly.newPlot('groupby-plot', [{
                x: x, y: y, type: 'bar', marker: { color: '#1E90FF' }
            }], plotlyLayout(`Sales by ${cat}`), { responsive: true });

            // Smart Click Logic
            document.getElementById('groupby-plot').on('plotly_click', function (data) {
                const clicked = data.points[0].x;
                const filterEl = $(`#filter-${cat}`);
                if (filterEl) {
                    // Check if already filtered to this (toggle off)
                    if (filterEl.value === clicked) filterEl.value = "";
                    else filterEl.value = clicked;
                    applyGlobalFilters();
                }
            });
        }

        // --- Utilities ---
        function updateKPIs() {
            const sales = DATASET.reduce((a, b) => a + (b.Sales || 0), 0);
            const profit = DATASET.reduce((a, b) => a + (b.Profit || 0), 0);
            const margin = sales ? (profit / sales) * 100 : 0;

            // Scenario
            const sliderVal = parseInt($('#price-slider').value) / 100;
            const projProfit = DATASET.reduce((sum, r) => {
                const newSales = (r.Sales || 0) * (1 + sliderVal);
                const m = (r.Sales || 0) > 0 ? (r.Profit || 0) / r.Sales : 0;
                return sum + (newSales * m);
            }, 0);

            $('#kpi-panel').innerHTML = `
        <div class="kpi-card"><div class="kpi-value">$${sales.toLocaleString(undefined, { maximumFractionDigits: 0 })}</div><div class="kpi-label">Revenue</div></div>
        <div class="kpi-card"><div class="kpi-value">${margin.toFixed(1)}%</div><div class="kpi-label">Margin</div></div>
        <div class="kpi-card"><div class="kpi-value" style="color:${sliderVal > 0 ? '#00e676' : (sliderVal < 0 ? '#ff5252' : '#e7ecf3')}">$${projProfit.toLocaleString(undefined, { maximumFractionDigits: 0 })}</div><div class="kpi-label">Projected Profit</div></div>
    `;
            $('#scenario-val').innerText = (sliderVal > 0 ? '+' : '') + (sliderVal * 100) + '%';
        }

        function calculateStats() {
            const body = $('#stats-body');
            $('#stats-head').innerHTML = `<tr><th>Metric</th><th>Total/Mean</th><th>Max</th></tr>`;
            body.innerHTML = '';
            AVAILABLE_METRICS.numeric.forEach(m => {
                const vals = DATASET.map(r => r[m]);
                const sum = vals.reduce((a, b) => a + b, 0);
                const max = Math.max(...vals);
                body.insertRow().innerHTML = `<td>${m}</td><td>${(sum / vals.length).toFixed(1)}</td><td>${max}</td>`;
            });
        }

        function showMsg(id, msg) { $(`#${id}`).innerHTML = `<div class="placeholder-text">${msg}</div>`; }

        function populateControls() {
            const div = $('#global-filters');
            div.innerHTML = '';
            AVAILABLE_METRICS.categorical.forEach(cat => {
                const sel = document.createElement('select');
                sel.id = `filter-${cat}`; sel.className = 'select';
                sel.innerHTML = `<option value="">${cat}</option>` + [...new Set(ORIGINAL_DATASET.map(r => r[cat]))].map(v => `<option value="${v}">${v}</option>`).join('');
                sel.addEventListener('change', applyGlobalFilters);
                div.appendChild(sel);
            });

            const cats = AVAILABLE_METRICS.categorical.map(c => `<option value="${c}">${c}</option>`).join('');
            $('#group-by-cat').innerHTML = cats;
            $('#sankey-source').innerHTML = cats;
            $('#sankey-target').innerHTML = cats;
        }



        function calculateHealthScore() {
            let totalCells = DATASET.length * HEADERS.length;
            let badCells = 0;

            // 1. Missing Values Check
            ORIGINAL_DATASET.forEach(row => {
                HEADERS.forEach(header => {
                    const val = row[header];
                    if (val === null || val === undefined || val === "") badCells++;
                });
            });

            // 2. Duplicate Rows Check (New Logic)
            const uniqueRows = new Set(ORIGINAL_DATASET.map(r => JSON.stringify(r)));
            const duplicateCount = ORIGINAL_DATASET.length - uniqueRows.size;
            // Penalty: We penalize duplicates slightly less than missing data
            const dupPenalty = (duplicateCount / ORIGINAL_DATASET.length) * 100;

            // Score Calculation
            if (totalCells === 0) totalCells = 1;
            let score = Math.round(100 - ((badCells / totalCells) * 100) - (dupPenalty * 0.5));
            if (score < 0) score = 0;

            // UI Update
            const scoreEl = document.getElementById('health-score');
            scoreEl.innerText = `${score}%`;
            const badgeIcon = document.querySelector('.health-icon');

            // Logic: Disable Forecast if Health < 50%
            const btn = $('#btn-forecast');

            if (score < 50) {
                badgeIcon.style.color = '#ff5252'; // Red
                if (btn) {
                    btn.disabled = true;
                    btn.style.opacity = 0.5;
                    btn.style.cursor = 'not-allowed';
                    btn.innerText = "Bad Data (Fix First)";
                    btn.title = "Score too low. Remove duplicates or fill missing data.";
                }
            } else if (score < 80) {
                badgeIcon.style.color = '#ffb74d'; // Orange
                enableForecastBtn();
            } else {
                badgeIcon.style.color = '#00e676'; // Green
                enableForecastBtn();
            }
        }



        function loadData() {
            try {
                const storedData = localStorage.getItem('dashboardData');
                if (storedData) {
                    const parsed = JSON.parse(storedData);
                    HEADERS = parsed.headers;
                    DATASET = parsed.data;
                    ORIGINAL_DATASET = [...parsed.data]; // <--- CRITICAL FIX: Populate backup data

                    // Identify Categorical/Numeric columns for filters
                    if (DATASET.length > 0) {
                        AVAILABLE_METRICS.numeric = HEADERS.filter(h => typeof DATASET[0][h] === 'number');
                        AVAILABLE_METRICS.categorical = HEADERS.filter(h => typeof DATASET[0][h] === 'string');
                    }

                    return true;
                }
            } catch (e) {
                console.error("Failed to load data from storage:", e);
            }
            return false;
        }

        function parseCSV(text) {
            const lines = text.trim().split(/\r\n|\n/);
            HEADERS = lines[0].split(',').map(h => h.trim());
            DATASET = lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                HEADERS.forEach((header, i) => {
                    const value = values[i] ? values[i].trim() : '';
                    obj[header] = isNaN(value) || value === '' ? value : parseFloat(value);
                });
                return obj;
            });
        }

        function enableForecastBtn() {
            const btn = $('#btn-forecast');
            if (btn) {
                btn.disabled = false;
                btn.style.opacity = 1;
                btn.style.cursor = 'pointer';
                btn.innerText = "Forecast (3 Mo)";
                btn.title = "Click to generate AI prediction";
            }
        }

        function applyGlobalFilters() {
            DATASET = [...ORIGINAL_DATASET];
            let active = false;

            // Apply filters
            AVAILABLE_METRICS.categorical.forEach(cat => {
                const el = $(`#filter-${cat}`);
                // Safety check: ensure dropdown exists
                if (el && el.value) {
                    DATASET = DATASET.filter(r => String(r[cat]) === el.value);
                    active = true;
                }
            });

            // Handle Reset Button Visibility (Safety check added)
            const resetBtn = $('#reset-container');
            if (resetBtn) {
                resetBtn.style.opacity = active ? '1' : '0';
                // Optional: prevent clicking if hidden
                resetBtn.style.pointerEvents = active ? 'auto' : 'none';
            }

            refreshDashboard();
        }

        function refreshDashboard() {
            updateKPIs();
            drawTrend();
            drawMap();
            drawCluster();
            drawCorrelation();
            drawSankey();
            drawDrill();
            calculateStats();
        }

        // --- Init (Corrected Structure) ---
        (function () {
            setupSidebar();
            checkLoginStatus();

            // 1. Load Data or use Dummy Data
            if (!loadData()) {
                console.log("No data in localStorage, using demo data.");
                const defaultCSV = ``;
                parseCSV(defaultCSV);
            }

            // 2. Start Pipeline (Now inside the function so it waits for data)
            if (DATASET.length > 0) {
                ORIGINAL_DATASET = JSON.parse(JSON.stringify(DATASET)); // Deep copy
                runDataPipeline(); // AUTO-RUN EVERYTHING
            }

            // 3. Attach Listeners
            const resetBtn = $('#btn-reset-filters');
            if (resetBtn) {
                resetBtn.onclick = () => {
                    $$('#global-filters select').forEach(s => s.value = "");
                    applyGlobalFilters();
                };
            }
            $('#price-slider').oninput = updateKPIs;
            $('#group-by-cat').onchange = drawDrill;
            $('#sankey-source').onchange = drawSankey;
            $('#sankey-target').onchange = drawSankey;

            $('#btn-forecast').onclick = () => {
                // Only works if button is enabled (Health Score check is handled in calculateHealthScore)
                drawTrend(true);
            };

            $('#btn-generate-ai').onclick = () => {
                $('#ai-container').style.display = 'block';
                const sales = DATASET.reduce((a, b) => a + (b.Sales || 0), 0);
                $('#ai-text').innerHTML = `<strong>AI Summary:</strong> Total Revenue: $${sales.toLocaleString()}. Anomalies detected in Trend Analysis. Correlation matrix cleaned for clarity.`;
            };

            $('#btn-download-pdf').onclick = () => {
                const doc = new window.jspdf.jsPDF();
                doc.autoTable({ html: '#stats-table-export' });
                doc.save('report.pdf');
            };

        })();


        // --- INITIALIZATION (Runs on Page Load) ---
        (function () {
            // 1. Try to load data from Dashboard memory
            if (loadData()) {
                // 2. If data exists, Calculate Health immediately
                calculateHealthScore();

                // 3. Optional: If you have filter logic, apply it here
                // applyGlobalFilters(); 
            } else {
                // 4. No data found (User came directly to Analytics without uploading)
                const scoreEl = document.getElementById('health-score');
                if (scoreEl) scoreEl.innerText = "--%";
                console.log("No dataset found. Go to Dashboard to upload file.");
            }
        })();
    </script>
</body>

</html>