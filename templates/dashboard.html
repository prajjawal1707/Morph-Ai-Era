<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MORPH-AI-ERA â€¢ Dashboard</title>

    <!-- Icons & Plotly -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        /* This defines the light theme variables. */
        .light-mode {
            --bg: #f8f9fa;
            --panel: #ffffff;
            --panel-2: #f1f3f5;
            --muted: #6c757d;
            --text: #212529;
            --brand: #1E90FF;
            --border: #dee2e6;
            --input-bg: #f1f3f5;
            --danger: #ef4444;
            --success: #28a745;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, .08);
            --toast-bg: #212529;
            --toast-text: #ffffff;
        }
    </style>
    <script>
        // This script runs instantly to apply the saved theme without a flicker.
        (function () {
            const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
            if (theme === 'light') {
                document.documentElement.classList.add('light-mode');
            }
        })();
    </script>

    <style>
        :root {
            --bg: #0f1115;
            --panel: #1b1f2a;
            --panel-2: #111521;
            --muted: #9aa4b2;
            --text: #e7ecf3;
            --brand: #1E90FF;
            --ok: #28a745;
            --warn: #f59e0b;
            --danger: #ef4444;
            --chip: #0d1320;
            --chip-border: #293245;
            --card-shadow: 0 8px 28px rgba(0, 0, 0, .35);
            --radius: 14px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, Apple Color Emoji, Segoe UI Emoji;
        }

        /* ===== Shell ===== */
        .wrap {
            display: flex;
            min-height: 100dvh;
        }

        /* ===== Sidebar ===== */
        .sidebar {
            position: sticky;
            top: 0;
            left: 0;
            height: 100vh;
            width: 70px;
            background: var(--panel-2);
            border-right: 1px solid #202533;
            padding: 14px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: width 0.25s ease;
            overflow: hidden;
            z-index: 1000;
        }

        .sidebar.expanded {
            width: 220px;
            align-items: flex-start;
        }

        .brand {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            /* Changed from width */
            height: 44px;
            /* width: 100px; */
            border-radius: 12px;
            background: #0c1a33;
            border: 1px solid #1b2a44;
            color: var(--brand);
            font-weight: 700;
            margin-bottom: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .brand span {
            margin-left: 10px;
            font-size: 18px;
            font-weight: 700;
            white-space: nowrap;
            display: none;
        }

        .sidebar.expanded .brand span {
            display: inline;
        }

        .sidebar .spacer {
            flex-grow: 1;
        }

        .nav {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            flex-shrink: 0;
        }

        .navbtn {
            width: 100%;
            height: 44px;
            border-radius: 12px;
            border: 1px solid #1e2534;
            background: #0e1422;
            color: #a9b3c3;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 12px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-decoration: none;
            /* For anchor tags */
        }

        .navbtn:hover {
            background: #1c2637;
            color: #fff;
        }

        .navbtn span {
            display: none;
            white-space: nowrap;
        }

        .sidebar.expanded .navbtn span {
            display: inline;
        }

        /* --- NEW AUTH STYLES --- */
        .auth-status {
            display: none;
            /* Hidden when sidebar is collapsed */
            padding: 15px;
            margin-top: 15px;
            border-top: 1px solid #202533;
        }

        .sidebar.expanded .auth-status {
            display: block;
        }

        #userStatus {
            font-size: 13px;
            color: var(--muted);
            margin: 0 0 10px 0;
            white-space: nowrap;
        }

        #authLinks a {
            color: var(--brand);
            text-decoration: none;
            font-size: 14px;
            margin-right: 15px;
            font-weight: 500;
        }

        #authLinks a:hover {
            text-decoration: underline;
        }

        #mobile-toggle {
            position: fixed;
            top: 14px;
            left: 10px;
            z-index: 1001;
            display: none;
            /* Hidden by default */
        }


        .main {
            flex: 1;
            padding: 24px;
            overflow-x: hidden;
        }

        /* --- NEW: Credit Display Box Styles --- */
        .credit-display-box {
            position: absolute;
            top: 24px;
            right: 24px;
            z-index: 100;
            text-align: center;

            /* --- Default state (> 0 credits) --- */
            /* Box is transparent and has no padding */
            background: transparent;
            border: none;
            padding: 0;
            box-shadow: none;
            border-radius: 12px;

            /* --- Added transition for smoothness --- */
            transition: all 0.3s ease;
        }

        /* --- "Show Box" state (<= 0 credits) --- */
        /* This class is added by JavaScript when credits are <= 0 */
        .credit-display-box.show-box {
            background: var(--panel);
            border: 1px solid #212735;
            padding: 12px 16px;
            box-shadow: var(--card-shadow);
        }

        /* --- "Credits Remaining" text --- */
        .credit-display-box div:first-child {
            display: none;
            /* Hidden by default */
            font-size: 13px;
            /* Made this smaller than the number */
            color: var(--muted);
            margin-bottom: 4px;
        }

        /* Show the text ONLY when the full box is visible */
        .credit-display-box.show-box div:first-child {
            display: block;
        }

        /* --- The credit number --- */
        #credit-count {
            font-size: 18px;
            font-weight: 800;
            color: var(--brand);
            line-height: 1.1;

            /* --- This is the default "number only" style --- */
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        /* --- Style for the number when the box appears --- */
        .credit-display-box.show-box #credit-count {
            background: transparent;
            /* Remove the number's background */
            padding: 0;
            font-size: 24px;
            /* Make it bigger inside the box */
        }

        /* This class still controls the color (blue vs. red) */
        #credit-count.no-credits {
            color: var(--danger);
        }

        /* --- "Buy Credits" link --- */
        .buy-credits-link {
            display: none;
            /* Hidden by default */
            font-size: 13px;
            color: var(--brand);
            text-decoration: none;
            font-weight: 600;
            /* margin-top: 8px; */
        }

        /* Show the link ONLY when the full box is visible */
        .credit-display-box.show-box .buy-credits-link {
            display: block;
        }

        .buy-credits-link:hover {
            text-decoration: underline;
        }

        /* --- Media queries remain the same --- */
        @media (max-width: 640px) {
            .main {
                padding-top: 100px;
                /* Add padding to avoid overlap */
            }

            .credit-display-box {
                /* top: 80px; */
                /* Position it below the mobile toggle */
                right: 18px;

            }

            /* We need to update the "show-box" for mobile */
            .credit-display-box.show-box {
                padding: 8px 12px;
                /* Ensures padding is correct on mobile */
            }

            /* And update the "number only" style for mobile */
            .credit-display-box:not(.show-box) {
                /* When box is hidden, only show number */
                top: 80px;
                left: auto;
                /* Reset left */
                right: 18px;
                /* Stick to the right */
            }

            .title {
                margin-top: 18px;
                /* Add margin to the title */
            }
        }

        .title {
            text-align: center;
            margin: 0 0 6px 0;
            font-size: 40px;
            font-weight: 800;
            color: #cfe5ff;
        }

        .subtitle {
            text-align: center;
            color: var(--muted);
            margin: 0 0 24px 0
        }

        .metrics {
            display: grid;
            grid-template-columns: 1fr;
            /* Mobile: 1 column */
            gap: 18px;
            margin-bottom: 18px;
        }

        .card-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .card-controls .select {
            flex: 1;
            height: 30px;
            font-size: 12px;
        }

        .card {
            background: linear-gradient(180deg, var(--panel), var(--panel-2));
            border: 1px solid #212735;
            border-radius: var(--radius);
            padding: 18px 20px;
        }

        .metric-label {
            color: #9fb1c7;
            font-size: 14px
        }

        .metric-val {
            font-size: 28px;
            font-weight: 800;
            color: #67b2ff;
            margin-top: 8px
        }

        .bar {
            background: linear-gradient(180deg, #121722, #0e1421);
            border: 1px solid #1f2736;
            border-radius: var(--radius);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 18px;
        }

        .group {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .label {
            color: #c8d2e0;
            font-size: 14px
        }

        .select,
        .btn {
            height: 36px;
            border-radius: 10px;
            border: 1px solid #263048;
            background: #12192b;
            color: #e6edf6;
            padding: 0 12px;
            font-size: 14px;
        }

        .select {
            appearance: none;
            padding-right: 26px;
            background-image: linear-gradient(45deg, transparent 50%, #7f8aa0 50%), linear-gradient(135deg, #7f8aa0 50%, transparent 50%);
            background-position: calc(100% - 16px) 50%, calc(100% - 11px) 50%;
            background-size: 6px 6px, 6px 6px;
            background-repeat: no-repeat;
        }

        .btn {
            cursor: pointer;
        }

        .btn.primary {
            background: #1E90FF;
            border-color: #2579d8;
            color: #001527;
            font-weight: 700
        }

        .btn.success {
            background: var(--ok);
            border-color: #1d8a36;
            color: #02140a;
            font-weight: 700
        }

        input[type="file"] {
            display: none
        }

        .file-label {
            border: 1px dashed #2d3a54;
            background: #12192b;
            color: #cfe1ff;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            height: 36px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .panel {
            position: relative
        }

        .panel .head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #cfd8e6;
            font-weight: 700;
        }

        .panel .head .controls {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .plot {
            width: 100%;
            height: 400px;
            border-radius: 12px;
            border: 1px solid #202a3a;
            background: linear-gradient(180deg, #101625, #0c121f);
            overflow: hidden;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            /* Mobile: 1 column */
            gap: 18px;
            margin-top: 18px;
        }

        .grid .plot {
            height: 340px;
        }

        /* --- RESPONSIVE BREAKPOINTS --- */

        /* Tablets and up */
        @media (min-width: 640px) {
            .metrics {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Desktops and up */
        @media (min-width: 1024px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Large desktops */
        @media (min-width: 1280px) {
            .metrics {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Mobile specific sidebar */
        @media (max-width: 768px) {
            #mobile-toggle {
                display: flex;
            }

            .wrap {
                display: block;
            }

            .sidebar {
                position: fixed;
                width: 220px;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                align-items: flex-start;
            }

            .sidebar.is-open {
                transform: translateX(0);
            }

            .sidebar.is-open .brand span,
            .sidebar.is-open .navbtn span {
                display: inline;
            }

            .sidebar.is-open .auth-status {
                display: block;
            }
        }

        .card-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .card-controls .select {
            flex: 1;
            height: 30px;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div id="mobile-toggle" class="brand">MAE</div>
    <div class="wrap">

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="brand" id="toggleSidebar">MAE <span>MORPH-AI-ERA</span></div>
            <nav class="nav">
                <a href="/dashboard" class="navbtn"><i class="fa-solid fa-gauge-high"></i><span>Dashboard</span></a>
                <a href="/analytics" class="navbtn"><i class="fa-solid fa-chart-line"></i><span>Analytics</span></a>
                <a href="/history" class="navbtn"><i class="fa-regular fa-clock"></i><span>History</span></a>
            </nav>
            <div class="spacer"></div>
            <nav class="nav">
                <a href="/settings" class="navbtn"><i class="fa-solid fa-gear"></i><span>Settings</span></a>
                <a href="/profile" class="navbtn"><i class="fa-regular fa-user"></i><span>Profile</span>
                </a>
            </nav>


            <!-- NEW: Auth Status Section -->
            <div class="auth-status">
                <p id="userStatus">Loading status...</p>
                <div id="authLinks"></div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main" id="main-content">
            <!-- adding credit logic -->
            <div class="credit-display-box">
                <div>Credits</div>
                <div id="credit-count">5</div>
                <a href="https://rzp.io/rzp/O7H1VONQ" class="buy-credits-link" id="buy-credits-link">
                    Buy Credits
                </a>
            </div>

            <h1 class="title">Welcome to MORPH-AI-ERA</h1>
            <p class="subtitle">Dashboard Overview</p>

            <section class="metrics">

                <div class="card">
                    <div class="card-controls">
                        <select class="select card-metric-select" id="metric-1"></select>
                        <select class="select card-agg-select" id="agg-1">
                            <option value="sum">Total</option>
                            <option value="mean">Average</option>
                            <option value="max">Max</option>
                            <option value="min">Min</option>
                            <option value="count">Count</option>
                        </select>
                    </div>
                    <div class="metric-label" id="label-1"></div>
                    <div class="metric-val" id="val-1"></div>
                </div>
                <div class="card">
                    <div class="card-controls">
                        <select class="select card-metric-select" id="metric-2"></select>
                        <select class="select card-agg-select" id="agg-2">
                            <option value="mean">Average</option>
                            <option value="sum">Total</option>
                            <option value="max">Max</option>
                            <option value="min">Min</option>
                            <option value="count">Count</option>
                        </select>
                    </div>
                    <div class="metric-label" id="label-2"></div>
                    <div class="metric-val" id="val-2"></div>
                </div>
                <div class="card">
                    <div class="card-controls">
                        <select class="select card-metric-select" id="metric-3"></select>
                        <select class="select card-agg-select" id="agg-3">
                            <option value="max">Max</option>
                            <option value="min">Min</option>
                            <option value="sum">Total</option>
                            <option value="mean">Average</option>
                            <option value="count">Count</option>
                        </select>
                    </div>
                    <div class="metric-label" id="label-3"></div>
                    <div class="metric-val" id="val-3"></div>
                </div>
                <div class="card">
                    <div class="card-controls">
                        <select class="select card-metric-select" id="metric-4"></select>
                        <select class="select card-agg-select" id="agg-4">
                            <option value="min">Min</option>
                            <option value="max">Max</option>
                            <option value="sum">Total</option>
                            <option value="mean">Average</option>
                            <option value="count">Count</option>
                        </select>
                    </div>
                    <div class="metric-label" id="label-4"></div>
                    <div class="metric-val" id="val-4"></div>
                </div>
            </section>
            <section class="bar">
                <div class="group"><span class="label">Upload</span><label for="fileInput" class="file-label"><i
                            class="fa-solid fa-file-arrow-up"></i> File</label><input id="fileInput" type="file"
                        accept=".csv" /></div>
                <div class="group"><span class="label">Views</span><select id="load-view" class="select">
                        <option value="">Load View</option>
                    </select><button id="save-view" class="btn">Save View</button></div>
                <div style="flex:1"></div>
                <div class="group" id="filter-status" style="display:none;"><span class="label">Filters
                        Active!</span><button id="clear-filters" class="btn">Clear Filters</button></div>
                <div class="group"><button id="calc-running-total" class="btn">Running Total</button></div>
                <div class="group">
                    <button id="btnUpdate" class="btn primary"><i class="fa-solid fa-rotate"></i>&nbsp;Update
                        Chart</button>
                    <button id="btnCalc" class="btn success"><i class="fa-solid fa-calculator"></i>&nbsp;Calculate
                        Metrics</button>
                </div>
            </section>

            <section class="card panel" style="padding:14px;">
                <div class="head">
                    <span>Interactive Chart</span>
                    <div class="controls">
                        <select id="u-type" class="select">
                            <optgroup label="Bar & Column">
                                <option value="bar-h">Bar Chart (Horizontal)</option>
                                <option value="bar">Column Chart (Vertical)</option>
                                <option value="clustered-column">Clustered Column</option>
                                <option value="stacked-bar">Stacked Bar</option>
                                <option value="stacked-column">Stacked Column</option>
                            </optgroup>
                            <optgroup label="Line & Area">
                                <option value="line">Line Chart</option>
                                <option value="area">Area Chart</option>
                                <option value="stacked-area">Stacked Area Chart</option>
                            </optgroup>
                            <optgroup label="Proportional">
                                <option value="pie">Pie Chart</option>
                                <option value="donut">Donut Chart</option>
                                <option value="treemap">Tree Map</option>
                                <option value="sunburst">Sunburst Chart</option>
                            </optgroup>
                            <optgroup label="Relational">
                                <option value="scatter">Scatter Chart</option>
                                <option value="bubble">Bubble Chart</option>
                                <option value="box">Box Plot</option>
                                <option value="violin">Violin Plot</option>
                            </optgroup>
                            <optgroup label="Specialized">
                                <option value="waterfall">Waterfall Chart</option>
                                <option value="funnel">Funnel Chart</option>
                                <option value="gauge">Gauge Chart</option>
                            </optgroup>
                            <optgroup label="Data Display">
                                <option value="heatmap">Matrix (Heatmap)</option>
                            </optgroup>
                            <optgroup label="Geographical">
                                <option value="choropleth">Filled Map (Choropleth)</option>
                            </optgroup>
                            <optgroup label="Hierarchical">
                                <option value="decomposition-tree">Decomposition Tree</option>
                            </optgroup>
                            <optgroup label="Combo">
                                <option value="combo">Combo (Line + Column)</option>
                            </optgroup>
                        </select>
                        <select id="u-metric" class="select"></select>
                    </div>
                </div>
                <div id="main-plot" class="plot"></div>
            </section>

            <!-- 2x2 GRID CHARTS (With Full Controls) -->
            <section class="grid">
                <div class="card panel">
                    <div class="head">
                        <span>Sales Trend</span>
                        <div class="controls">
                            <select id="st-type" class="select">
                                <optgroup label="Common Charts">
                                    <option value="line">Line Chart</option>
                                    <option value="bar">Column Chart</option>
                                    <option value="bar-h">Bar Chart (Horizontal)</option>
                                    <option value="area">Area Chart</option>
                                </optgroup>
                                <optgroup label="Proportional">
                                    <option value="pie">Pie Chart</option>
                                    <option value="donut">Donut Chart</option>
                                </optgroup>
                            </select>
                            <select id="st-metric" class="select">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>
                    <div id="sales-trend" class="plot"></div>
                </div>
                <div class="card panel">
                    <div class="head">
                        <span>Profit Trend</span>
                        <div class="controls">
                            <select id="pt-type" class="select">
                                <optgroup label="Common Charts">
                                    <option value="bar">Column Chart</option>
                                    <option value="line">Line Chart</option>
                                    <option value="bar-h">Bar Chart (Horizontal)</option>
                                    <option value="area">Area Chart</option>
                                </optgroup>
                                <optgroup label="Proportional">
                                    <option value="pie">Pie Chart</option>
                                    <option value="donut">Donut Chart</option>
                                </optgroup>
                            </select>
                            <select id="pt-metric" class="select">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>
                    <div id="profit-trend" class="plot"></div>
                </div>
                <div class="card panel">
                    <div class="head"><span>Sales vs Profit (Overlay)</span>
                        <div class="controls">
                            <select id="ovl-type-a" class="select">
                                <option value="bar">Bar (Sales)</option>
                                <option value="line">Line (Sales)</option>
                            </select>
                            <select id="ovl-type-b" class="select">
                                <option value="line">Line (Profit)</option>
                                <option value="bar">Bar (Profit)</option>
                            </select>
                            <i class="fa-solid fa-expand expand-btn" data-plot="overlay-plot"></i>
                        </div>
                    </div>
                    <div id="overlay-plot" class="plot"></div>
                </div>
                <div class="card panel">
                    <div class="head"><span>Sales vs Profit (Scatter)</span>
                        <div class="controls">
                            <button id="sc-refresh" class="btn"><i class="fa-solid fa-arrows-rotate"></i></button>
                            <i class="fa-solid fa-expand expand-btn" data-plot="scatter-plot"></i>
                        </div>
                    </div>
                    <div id="scatter-plot" class="plot"></div>
                </div>
            </section>
        </main>



    </div>
    <footer
        style="text-align: center; padding: 15px 20px; ; background-color: #11151f; font-size: 12px; color: #595959;">
        <p>&copy; 2025 Morph-Ai-Era. All Rights Reserved.</p>
        <div class="footer-links" style="margin-top: 5px;">
            <a href="/terms" style="color: #3b3b3c; margin: 0 10px;">Terms & Conditions</a> |
            <a href="/privacy" style="color: #414152; margin: 0 10px;">Privacy Policy</a> |
            <a href="/refunds" style="color: #4d4d90; margin: 0 10px;">Refund Policy</a> |
            <a href="/shipping" style="color: #3b3bba; margin: 0 10px;">Shipping Policy</a> |
            <a href="/contact" style="color: #0404d2; margin: 0 10px;">Contact Us</a>
        </div>
    </footer>



    <script>
        async function loadPage(url) {
            try {
                // Fetch the new HTML content from your server
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error("Page not found");
                }
                const newContent = await response.text();

                // Find your main content area and replace its HTML
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = newContent;

                // If the loaded content has its own scripts, you might need to evaluate them
                // This is an advanced topic, but keep it in mind.

            } catch (error) {
                console.error('Failed to load page:', error);
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = '<h1>Error: Could not load page.</h1>';
            }
        }
    </script>
    <script>
        // --- Sidebar, Auth & General Setup ---
        const $ = q => document.querySelector(q);
        const $$ = q => document.querySelectorAll(q);

        function setupSidebar() {
            const sidebar = document.getElementById('sidebar');
            const desktopToggle = document.getElementById('toggleSidebar');
            const mobileToggle = document.getElementById('mobile-toggle');

            desktopToggle.addEventListener('click', () => {
                if (window.innerWidth > 768) {
                    sidebar.classList.toggle('expanded');
                } else {
                    sidebar.classList.remove('is-open');
                }
            });

            mobileToggle.addEventListener('click', () => {
                sidebar.classList.toggle('is-open');
            });

            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && sidebar.classList.contains('is-open')) {
                    if (!sidebar.contains(e.target) && e.target !== mobileToggle) {
                        sidebar.classList.remove('is-open');
                    }
                }
            });

            sidebar.querySelectorAll('.navbtn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('is-open');
                    }
                });
            });
        }
        // THIS IS YOUR NEW, CORRECT checkLoginStatus FUNCTION

        async function checkLoginStatus() {
            const userStatusP = document.getElementById('userStatus');
            const authLinksDiv = document.getElementById('authLinks');

            try {
                // This line calls your Python backend
                const response = await fetch('/users/me');
                const user = await response.json();

                if (user.loggedIn) {
                    userStatusP.textContent = `Logged in as: ${user.username}`;
                    // Corrected logout link
                    authLinksDiv.innerHTML = `<a href="/logout">Log Out</a>`;
                } else {
                    userStatusP.textContent = 'Using as: Guest';
                    authLinksDiv.innerHTML = `<a href="/login">Login</a> <a href="/signup">Sign Up</a>`;
                }
            } catch (error) {
                console.error('Error checking login status:', error);
                userStatusP.textContent = 'Error loading status';
                authLinksDiv.innerHTML = `<a href="/login">Login</a> <a href="/signup">Sign Up</a>`;
            }
        }
        checkLoginStatus();


        // This REPLACES your old openPaymentPopup function
        async function openPaymentPopup() {
            // This check will now work because CURRENT_USER is set by updateAuthStatus
            if (!CURRENT_USER) {
                alert("Please log in to buy credits.");
                return;
            }

            try {
                // --- STEP 1: Create the Order from YOUR backend ---
                // We will add this '/api/create-order' route to auth.py next
                const orderResponse = await fetch('/api/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: 1, // Amount in INR
                        currency: 'INR'
                    })
                });

                if (!orderResponse.ok) {
                    throw new Error('Failed to create payment order.');
                }

                const order = await orderResponse.json();

                // --- STEP 2: Configure Razorpay Options ---
                const options = {
                    "key": order.key_id, // Use the public key from your backend
                    "amount": order.amount,
                    "currency": order.currency,
                    "order_id": order.order_id,
                    "name": "Morph-AI-Era",
                    "description": "Buy 50 Credits",
                    "handler": async function (response) {
                        try {
                            // --- STEP 3: Verify the Payment with YOUR backend ---
                            // We will add this '/api/verify-payment' route to auth.py next
                            const verifyResponse = await fetch('/api/verify-payment', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    razorpay_order_id: response.razorpay_order_id,
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    razorpay_signature: response.razorpay_signature,
                                })
                            });

                            const verifyData = await verifyResponse.json();

                            if (verifyData.status === 'success') {
                                // --- STEP 4: Update UI ---
                                alert('Payment Successful! 50 credits have been added.');
                                CURRENT_CREDITS = verifyData.new_credits; // Get new total from backend
                                updateCreditDisplay();
                            } else {
                                throw new Error(verifyData.error || 'Payment verification failed.');
                            }

                        } catch (error) {
                            console.error('Verification Error:', error);
                            alert('Payment was received but could not be verified. Please contact support.');
                            _
                        }
                    },
                    "prefill": {
                        "email": CURRENT_USER.email,
                        "name": CURRENT_USER.username
                    },
                    "theme": {
                        "color": "#1E90FF"
                    }
                };

                // --- STEP 5: Open the Popup ---
                const rzp = new Razorpay(options);
                rzp.open();

            } catch (error) {
                console.error('Payment Error:', error);
                alert('Could not start payment. Please try again.');
            }
        }

        // --- Data & History Management ---
        let CURRENT_CREDITS = 0; // Default to 0, will be fetched from backend
        let CURRENT_USER = null; // Default to null
        let DATASET = [];
        let HEADERS = [];
        let AVAILABLE_METRICS = { numeric: [], categorical: [] };

        function logHistory(action, details) {
            try {
                const history = JSON.parse(localStorage.getItem('dashboardHistory')) || [];
                const user = "guest-user"; // Replace with real user logic
                history.unshift({ timestamp: new Date().toISOString(), user, action, details, csv: localStorage.getItem('lastCSV') || '' });
                localStorage.setItem('dashboardHistory', JSON.stringify(history.slice(0, 50))); // Keep last 50 entries
            } catch (e) { console.error("Could not log history:", e); }
        }
        // --- NEW: View Management ---
        const VIEW_CONTROL_IDS = [
            'metric-1', 'agg-1', 'metric-2', 'agg-2', 'metric-3', 'agg-3', 'metric-4', 'agg-4',
            'u-type', 'u-metric', 'st-type', 'st-metric', 'pt-type', 'pt-metric',
            'ovl-type-a', 'ovl-type-b'
        ];

        /**
         * Populates the "Load View" dropdown with saved views from localStorage.
         */
        function updateViewDropdown() {
            const allViews = JSON.parse(localStorage.getItem('dashboardViews')) || {};
            const select = $('#load-view');

            // Clear existing options, but keep the first "Load View" placeholder
            select.innerHTML = '<option value="">Load View</option>';

            for (const viewName in allViews) {
                const option = document.createElement('option');
                option.value = viewName;
                option.textContent = viewName;
                select.appendChild(option);
            }
        }

        /**
         * Saves the current state of all select dropdowns to localStorage.
         */
        function saveView() {
            const viewName = prompt("Enter a name for this view:");
            if (!viewName || viewName.trim() === "") {
                return; // User cancelled or entered no name
            }

            const viewState = {};
            for (const id of VIEW_CONTROL_IDS) {
                if ($(`#${id}`)) {
                    viewState[id] = $(`#${id}`).value;
                }
            }

            let allViews = JSON.parse(localStorage.getItem('dashboardViews')) || {};
            allViews[viewName.trim()] = viewState;
            localStorage.setItem('dashboardViews', JSON.stringify(allViews));

            updateViewDropdown(); // Refresh the list with the new view
            alert('View "' + viewName.trim() + '" saved!');
            logHistory("Save View", `Saved view: ${viewName.trim()}`);
        }

        /**
         * Loads a saved view from localStorage and applies it to the dashboard.
         */
        function loadView() {
            const viewName = $('#load-view').value;
            if (!viewName) return; // Ignore if they re-select "Load View"

            const allViews = JSON.parse(localStorage.getItem('dashboardViews')) || {};
            const viewState = allViews[viewName];

            if (!viewState) {
                alert('Error: Could not find view "' + viewName + '"');
                return;
            }

            // Apply the saved state to all controls
            for (const id in viewState) {
                if ($(`#${id}`)) {
                    $(`#${id}`).value = viewState[id];
                }
            }

            // IMPORTANT: Refresh the entire dashboard to show the loaded state
            refreshAll();

            $('#load-view').value = ''; // Reset the dropdown to the placeholder
            logHistory("Load View", `Loaded view: ${viewName}`);
        }

        // --- Data Loading & Parsing ---
        function parseCSV(text) {
            const lines = text.trim().split(/\r\n|\n/);
            HEADERS = lines[0].split(',').map(h => h.trim());
            DATASET = lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                HEADERS.forEach((header, i) => {
                    const value = values[i] ? values[i].trim() : '';
                    obj[header] = isNaN(value) || value === '' ? value : parseFloat(value);
                });
                return obj;
            });
            // Save data for analytics page
            localStorage.setItem('dashboardData', JSON.stringify({ headers: HEADERS, data: DATASET }));
            localStorage.setItem('lastCSV', text); // Save raw CSV for history
        }


        // --- NEW: Credit Management Functions (SUPABASE) ---
        // let CURRENT_USER = null;

        // async function initCredits() {
        //     // Get the currently logged-in user from Supabase
        //     const { data: { user } } = await supabase.auth.getUser();

        //     if (user) {
        //         // User is logged in
        //         CURRENT_USER = user;

        //         // Fetch their profile and credit count
        //         let { data, error } = await supabase
        //             .from('profiles')
        //             .select('credits')
        //             .eq('id', user.id) // 'id' must match the user's ID
        //             .single(); // Get a single record

        //         if (error) {
        //             console.error('Error fetching profile:', error);
        //             CURRENT_CREDITS = 0;
        //         } else if (data) {
        //             CURRENT_CREDITS = data.credits;
        //         } else {
        //             // This might be a new user, let's check
        //             console.log('No profile found, checking... this should be handled by a trigger.');
        //             CURRENT_CREDITS = 5; // Fallback
        //         }

        //     } else {
        //         // User is a guest
        //         CURRENT_USER = null;
        //         CURRENT_CREDITS = 0; // Guests have 0 credits
        //         alert("You are using as a guest. Please log in to use credits.");
        //     } updateCreditDisplay();
        // }

        function updateCreditDisplay() {
            const creditBox = $('.credit-display-box'); // Get the main box
            const creditEl = $('#credit-count');

            if (!creditBox || !creditEl) return;

            creditEl.textContent = CURRENT_CREDITS; // Always set the number

            if (CURRENT_CREDITS <= 0) {
                creditBox.classList.add('show-box'); // Show the full box
                creditEl.classList.add('no-credits'); // Make the '0' red
            } else {
                creditBox.classList.remove('show-box'); // Hide the full box
                creditEl.classList.remove('no-credits'); // Make the number blue
            }
        }

        // --- UPDATED useCredit function ---
        // This now reports credit use to the backend
        function useCredit() {
            if (CURRENT_CREDITS <= 0) {
                if (CURRENT_USER) {
                    alert('You are out of credits! Please purchase more to continue.');
                } else {
                    alert('Please log in or sign up to use the app.');
                }
                return false; // Action is blocked
            }

            // 1. Subtract credits locally for instant UI update
            CURRENT_CREDITS--;
            updateCreditDisplay();

            // 2. Asynchronously update the database
            // We will add this '/api/use-credit' route to auth.py next
            if (CURRENT_USER) {
                fetch('/api/use-credit', { method: 'POST' })
                    .catch(err => console.error("Error reporting credit usage:", err));
            }

            return true; // Action is allowed
        }
        function updateCards() {
            for (let i = 1; i <= 4; i++) {
                const metric = $(`#metric-${i}`).value;
                const agg = $(`#agg-${i}`).value;
                if (!metric) continue;

                const values = DATASET.map(row => row[metric]).filter(v => typeof v === 'number');
                if (values.length === 0) continue;

                let result = 0;
                switch (agg) {
                    case 'sum': result = values.reduce((a, b) => a + b, 0); break;
                    case 'mean': result = values.reduce((a, b) => a + b, 0) / values.length; break;
                    case 'max': result = Math.max(...values); break;
                    case 'min': result = Math.min(...values); break;
                    case 'count': result = values.length; break;
                }

                let formattedResult = result.toLocaleString(undefined, { maximumFractionDigits: 2 });
                if (metric.toLowerCase().includes('sales') || metric.toLowerCase().includes('profit')) {
                    formattedResult = '$' + formattedResult;
                }

                $(`#label-${i}`).textContent = `${agg.charAt(0).toUpperCase() + agg.slice(1)} ${metric}`;
                $(`#val-${i}`).textContent = formattedResult;
            }
            logHistory("Update Cards", "Manually refreshed KPI cards");
        }



        // --- Analytics & Drawing Functions ---
        const plotlyLayout = (title, extra_settings = {}) => ({
            title: { text: title, font: { size: 16, color: '#dbe7ff' } },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            margin: { l: 50, r: 25, t: 40, b: 40 },
            xaxis: { gridcolor: '#1d2738', zeroline: false, tickfont: { color: '#b9c7dd' } },
            yaxis: { gridcolor: '#1d2738', zeroline: false, tickfont: { color: '#b9c7dd' } },
            showlegend: true,
            legend: { orientation: 'h', y: -0.25, font: { color: '#cbd6ea' } },
            ...extra_settings
        });
        const showPlotMessage = (plotId, message) => $(`#${plotId}`).innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--muted); padding: 20px; text-align: center;">${message}</div>`;

        function getSeries(metric) {
            if (AVAILABLE_METRICS.categorical.includes(metric)) {
                const aggregation = DATASET.reduce((acc, row) => {
                    const category = row[metric];
                    if (category) {
                        const value = row.Sales || 1;
                        acc[category] = (acc[category] || 0) + value;
                    }
                    return acc;
                }, {});
                return { labels: Object.keys(aggregation), values: Object.values(aggregation) };
            } else {
                const labelCol = AVAILABLE_METRICS.categorical[0] || HEADERS[0];
                return { labels: DATASET.map(row => row[labelCol]), values: DATASET.map(row => row[metric]) };
            }
        }

        function generateTracesAndLayout(type, metric) {
            if (!metric) { return { error: 'Please select a metric.' }; }
            let traces = [];
            let layout = plotlyLayout(metric);
            try {
                switch (type) {
                    case 'line': case 'bar': case 'area': {
                        const { labels, values } = getSeries(metric);
                        if (type === 'area') {
                            traces.push({ type: 'scatter', x: labels, y: values, name: metric, mode: 'lines', fill: 'tozeroy' });
                        } else {
                            traces.push({ type: type, x: labels, y: values, name: metric });
                        }
                        break;
                    }
                    case 'bar-h': {
                        const { labels, values } = getSeries(metric);
                        traces.push({ type: 'bar', x: values, y: labels, orientation: 'h', name: metric });
                        break;
                    }
                    case 'stacked-bar':
                    case 'stacked-area': case 'clustered-column': case 'stacked-column': {
                        if (!HEADERS.includes('Sales') || !HEADERS.includes('Profit')) { return { error: 'This chart requires "Sales" and "Profit" columns.' }; }
                        const sales = getSeries('Sales'); const profit = getSeries('Profit');
                        if (type === 'stacked-area') {
                            traces.push({ type: 'scatter', x: sales.labels, y: sales.values, name: 'Sales', fill: 'tozeroy', mode: 'none' });
                            traces.push({ type: 'scatter', x: profit.labels, y: profit.values, name: 'Profit', fill: 'tonexty', mode: 'none' });
                        } else {
                            traces.push({ type: 'bar', x: sales.labels, y: sales.values, name: 'Sales' });
                            traces.push({ type: 'bar', x: profit.labels, y: profit.values, name: 'Profit' });
                            layout.barmode = type.includes('stack') ? 'stack' : 'group';
                            if (type === 'stacked-bar') { traces.forEach(t => t.orientation = 'h'); }
                        }
                        break;
                    }
                    case 'pie': case 'donut': {
                        const { labels, values } = getSeries(metric);
                        traces.push({ type: 'pie', labels, values, hole: type === 'donut' ? 0.5 : 0, textinfo: 'percent', insidetextorientation: 'radial' });
                        break;
                    }
                    case 'scatter': case 'bubble': {
                        if (!HEADERS.includes('Sales') || !HEADERS.includes('Profit')) { return { error: 'Requires "Sales" and "Profit" columns.' }; }
                        const sales = getSeries('Sales'); const profit = getSeries('Profit');
                        const bubbleSizes = type === 'bubble' ? profit.values.map(p => Math.max(Math.abs(p) / 50, 10)) : 12;
                        traces.push({ type: 'scatter', x: sales.values, y: profit.values, mode: 'markers', marker: { size: bubbleSizes, color: profit.values, colorscale: 'Viridis', showscale: true } });
                        layout.xaxis.title = 'Sales'; layout.yaxis.title = 'Profit';
                        break;
                    }
                    case 'box': case 'violin': {
                        const { values } = getSeries(metric);
                        traces.push({ y: values, type: type, name: metric });
                        break;
                    }
                    case 'treemap': case 'sunburst': {
                        const cat1 = AVAILABLE_METRICS.categorical[0];
                        const cat2 = AVAILABLE_METRICS.categorical[1];
                        if (!cat1 || !cat2) { return { error: 'This chart requires at least two categorical columns.' }; }

                        const hierarchy = DATASET.reduce((acc, row) => {
                            const parent = row[cat1]; const child = row[cat2]; const value = row.Sales || 0;
                            if (!acc[parent]) acc[parent] = { children: {}, total: 0 };
                            acc[parent].children[child] = (acc[parent].children[child] || 0) + value;
                            acc[parent].total += value;
                            return acc;
                        }, {});

                        const labels = ['Total']; const parents = [''];
                        const values = [Object.values(hierarchy).reduce((sum, p) => sum + p.total, 0)];

                        for (const parent in hierarchy) {
                            labels.push(parent); parents.push('Total'); values.push(hierarchy[parent].total);
                            for (const child in hierarchy[parent].children) {
                                labels.push(child); parents.push(parent); values.push(hierarchy[parent].children[child]);
                            }
                        }
                        traces.push({ type: type, labels, parents, values, branchvalues: 'total' });
                        break;
                    }
                    case 'heatmap': {
                        const cat1 = AVAILABLE_METRICS.categorical[0];
                        const cat2 = AVAILABLE_METRICS.categorical[1];
                        if (!cat1 || !cat2) { return { error: 'Heatmap requires at least two categorical columns.' }; }
                        const xLabels = [...new Set(DATASET.map(r => r[cat1]))];
                        const yLabels = [...new Set(DATASET.map(r => r[cat2]))];
                        const zValues = yLabels.map(y => xLabels.map(x => {
                            const filtered = DATASET.filter(r => r[cat1] === x && r[cat2] === y);
                            return filtered.reduce((sum, r) => sum + (r[metric] || 0), 0);
                        }));
                        traces.push({ x: xLabels, y: yLabels, z: zValues, type: 'heatmap', colorscale: 'Viridis' });
                        break;
                    }
                    case 'choropleth': { return { error: `Map charts require specific geographical data (e.g., country codes) which was not found.` }; }
                    case 'decomposition-tree': { return { error: `Decomposition Tree is a placeholder for a complex custom visual.` }; }
                    case 'waterfall': case 'funnel': case 'gauge': {
                        return { error: `The "${type}" chart requires specific data structures. This is a placeholder visual.` };
                    }
                    case 'combo': {
                        if (!HEADERS.includes('Sales') || !HEADERS.includes('Profit')) { return { error: 'Combo chart requires "Sales" and "Profit" columns.' }; }
                        const sales = getSeries('Sales'); const profit = getSeries('Profit');
                        traces.push({ type: 'bar', x: sales.labels, y: sales.values, name: 'Sales' });
                        traces.push({ type: 'scatter', mode: 'lines', x: profit.labels, y: profit.values, name: 'Profit', yaxis: 'y2' });
                        layout.yaxis2 = { title: 'Profit', overlaying: 'y', side: 'right', showgrid: false, tickfont: { color: '#ff7f0e' } };
                        break;
                    }
                    default: return { error: `Chart type "${type}" is not implemented.` };
                }
                return { traces, layout };
            } catch (err) {
                console.error(`Failed to generate chart type "${type}":`, err);
                return { error: `Could not draw chart. The data might be in an incompatible format.` };
            }
        }


        function drawChart(plotId, type, metric) {
            const { traces, layout, error } = generateTracesAndLayout(type, metric);
            if (error) {
                if (error.includes("placeholder")) {
                    const staticData = {
                        waterfall: { x: ["Sales", "Consulting", "Maintenance", "Net"], y: [120, 80, -30, 170], measure: ["relative", "relative", "relative", "total"] },
                        funnel: { y: ["Visits", "Downloads", "Pricing", "Invoice", "Finalized"], x: [390, 270, 220, 110, 90] },
                        gauge: { value: 450, title: { text: "Avg. Transaction" }, gauge: { axis: { range: [null, 500] } } }
                    };
                    const chartType = type.split('-')[0];
                    const placeholderTrace = { type: chartType, ...staticData[chartType], mode: chartType === 'gauge' ? 'gauge+number' : undefined };
                    Plotly.react(plotId, [placeholderTrace], plotlyLayout(metric), { responsive: true, displayModeBar: false });
                    showPlotMessage(plotId, error);
                } else { showPlotMessage(plotId, error); }
                return;
            }
            if (plotId !== 'main-plot') { layout.title.text = ''; }
            Plotly.react(plotId, traces, layout, { responsive: true, displayModeBar: false });
        }

        function calculateRunningTotal() {
        // --- CREDIT CHECK ADDED ---
        if (!useCredit()) {
            return; // Stop if no credits
        } 
            const metric = $('#u-metric').value;
            if (!metric) {
                alert("Please select a metric in the 'Interactive Chart' panel first.");
                return;
            }

            if (!AVAILABLE_METRICS.numeric.includes(metric)) {
                alert("Running total can only be calculated for a numeric metric.");
                return;
            }

            // Try to find a 'Date' column, otherwise use the first categorical column
            let sortColumn = HEADERS.find(h => h.toLowerCase() === 'date');
            if (!sortColumn) {
                sortColumn = AVAILABLE_METRICS.categorical[0];
            }

            if (!sortColumn) {
                alert("Cannot calculate running total without a date or categorical column to sort by.");
                return;
            }

            // Create a copy of the data and sort it
            const sortedData = [...DATASET].sort((a, b) => {
                if (a[sortColumn] < b[sortColumn]) return -1;
                if (a[sortColumn] > b[sortColumn]) return 1;
                return 0;
            });

            // Calculate the running total
            let runningSum = 0;
            const labels = [];
            const values = [];

            for (const row of sortedData) {
                const value = row[metric] || 0; // Get the value, default to 0
                runningSum += value;

                labels.push(row[sortColumn]);
                values.push(runningSum);
            }

            // Draw the new chart on the main plot
            const trace = {
                type: 'scatter',
                mode: 'lines+markers',
                x: labels,
                y: values,
                name: `Running Total (${metric})`,
                fill: 'tozeroy' // Fills the area under the line
            };

            // Get the standard layout and update the title
            const layout = plotlyLayout(`Running Total of ${metric} (by ${sortColumn})`);

            Plotly.react('main-plot', [trace], layout, { responsive: true, displayModeBar: false });

            // Set the main chart's type dropdown to "line" so it matches what is shown
            $('#u-type').value = 'line';

            logHistory("Calculate Running Total", `Metric: ${metric}, Sorted by: ${sortColumn}`);
        }
        // --- UI & Control Functions ---
        function loadSummary() {
            if (DATASET.length === 0) return;
            const sales = DATASET.map(row => row.Sales || 0);
            const profits = DATASET.map(row => row.Profit || 0);
            $('#m-total').textContent = '$' + sales.reduce((a, b) => a + b, 0).toLocaleString();
            $('#m-avg').textContent = '$' + (profits.length > 0 ? (profits.reduce((a, b) => a + b, 0) / profits.length).toLocaleString(undefined, { maximumFractionDigits: 2 }) : 0);
            $('#m-max').textContent = '$' + (profits.length > 0 ? Math.max(...profits).toLocaleString() : 0);
            $('#m-min').textContent = '$' + (profits.length > 0 ? Math.min(...profits).toLocaleString() : 0);
            logHistory("Calculate Metrics", "Recalculated summary KPIs");
        }

        function populateControls() {
            AVAILABLE_METRICS.numeric = HEADERS.filter(h => h && DATASET.length > 0 && typeof DATASET[0][h] === 'number');
            AVAILABLE_METRICS.categorical = HEADERS.filter(h => h && DATASET.length > 0 && typeof DATASET[0][h] === 'string');
            const numericOptions = AVAILABLE_METRICS.numeric.map(c => `<option value="${c}">${c}</option>`).join('');
            const categoricalOptions = AVAILABLE_METRICS.categorical.map(c => `<option value="${c}">${c}</option>`).join('');
            const allMetricOptions = `<optgroup label="Categorical">${categoricalOptions}</optgroup><optgroup label="Numeric">${numericOptions}</optgroup>`;

            $('#u-metric').innerHTML = allMetricOptions;
            $('#st-metric').innerHTML = allMetricOptions;
            $('#pt-metric').innerHTML = allMetricOptions;

            // This part is new:
            $$('.card-metric-select').forEach(sel => sel.innerHTML = numericOptions);

            // Set defaults for the new cards
            if (HEADERS.includes('Sales')) $('#metric-1').value = 'Sales';
            if (HEADERS.includes('Profit')) {
                $('#metric-2').value = 'Profit';
                $('#metric-3').value = 'Profit';
                $('#metric-4').value = 'Profit';
            }
            if (HEADERS.includes('Sales')) $('#st-metric').value = 'Sales';
            if (HEADERS.includes('Profit')) $('#pt-metric').value = 'Profit';
        }


        // This function REPLACES both checkLoginStatus and initCredits
        async function updateAuthStatus() {
            const userStatusP = document.getElementById('userStatus');
            const authLinksDiv = document.getElementById('authLinks');

            try {
                // This calls your Python backend's /users/me endpoint
                const response = await fetch('/users/me');
                const user = await response.json();

                if (user.loggedIn) {
                    // User IS logged in
                    userStatusP.textContent = `Logged in as: ${user.username}`;
                    authLinksDiv.innerHTML = `<a href="/logout">Log Out</a>`;

                    // --- THIS IS THE FIX ---
                    // Set the global variables from the backend
                    CURRENT_USER = user;
                    CURRENT_CREDITS = user.credits || 0;
                    // ---------------------

                } else {
                    // User is a GUEST
                    userStatusP.textContent = 'Using as: Guest';
                    authLinksDiv.innerHTML = `<a href="/login">Login</a> <a href="/signup">Sign Up</a>`;

                    // --- THIS IS THE FIX ---
                    CURRENT_USER = null;
                    CURRENT_CREDITS = 0; // Guests have 0 credits
                    // ---------------------
                }
            } catch (error) {
                console.error('Error checking login status:', error);
                userStatusP.textContent = 'Error loading status';
                authLinksDiv.innerHTML = `<a href="/login">Login</a> <a href="/signup">Sign Up</a>`;
                CURRENT_USER = null;
                CURRENT_CREDITS = 0;
            }

            // After getting user info, update the credit display
            updateCreditDisplay();
        }

        updateAuthStatus();

        function drawMain() {
            drawChart('main-plot', $('#u-type').value, $('#u-metric').value);
            logHistory("Update Chart", `Main chart to ${$('#u-type').value} for ${$('#u-metric').value}`);
        }
        function drawSalesTrend() { drawChart('sales-trend', $('#st-type').value, $('#st-metric').value); }
        function drawProfitTrend() { drawChart('profit-trend', $('#pt-type').value, $('#pt-metric').value); }
        function drawOverlay() {
            if (!HEADERS.includes('Sales') || !HEADERS.includes('Profit')) { showPlotMessage('overlay-plot', '"Sales" & "Profit" required.'); return; }
            const typeA = $('#ovl-type-a').value.split(' ')[0].toLowerCase();
            const typeB = $('#ovl-type-b').value.split(' ')[0].toLowerCase();
            const { traces: tracesA } = generateTracesAndLayout(typeA, 'Sales');
            const { traces: tracesB } = generateTracesAndLayout(typeB, 'Profit');
            if (tracesA && tracesB) {
                Plotly.react('overlay-plot', [tracesA[0], tracesB[0]], plotlyLayout(''), { responsive: true, displayModeBar: false });
            }
        }
        function drawScatter() {
            if (!HEADERS.includes('Sales') || !HEADERS.includes('Profit')) { showPlotMessage('scatter-plot', '"Sales" & "Profit" required.'); return; }
            const { traces, layout } = generateTracesAndLayout('scatter', 'Sales');
            if (traces) {
                layout.title.text = '';
                Plotly.react('scatter-plot', traces, layout, { responsive: true, displayModeBar: false });
            }
        }
        function drawMain() {
            // --- CREDIT CHECK ADDED ---
            if (!useCredit()) {
                return; // Stop if no credits
            }
            // --- END CREDIT CHECK ---
            drawChart('main-plot', $('#u-type').value, $('#u-metric').value);
            logHistory("Update Chart", `Main chart to ${$('#u-type').value} for ${$('#u-metric').value}`);
        }

        function refreshAll() {
            populateControls();
            updateCards(); // Changed from loadSummary()
            drawChart('main-plot', $('#u-type').value, $('#u-metric').value);
            drawSalesTrend();
            drawProfitTrend();
            drawOverlay();
            drawScatter();
        }

        // --- Initial Load ---
        (function () {
            setupSidebar();
            updateAuthStatus(); // THIS IS THE ONLY ONE YOU NEED
            updateViewDropdown();
            $('#fileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // --- CREDIT CHECK FOR FILE UPLOAD ---
                if (!useCredit()) {
                    e.target.value = null; // Clear the file input
                    return; // Stop if no credits
                }
                // --- END CREDIT CHECK ---

                const reader = new FileReader();
                reader.onload = (event) => {
                    const csvText = event.target.result;
                    parseCSV(csvText);
                    logHistory("File Upload", `Uploaded ${file.name}`);
                    refreshAll(); // Refresh all charts with new data
                };
                reader.onerror = () => alert('Error reading file.');
                reader.readAsText(file);
            });

            // --- UPDATED Event Listeners ---

            // This button calls drawMain, which has the credit check
            $('#btnUpdate').addEventListener('click', drawMain);

            // This button has its own credit check
            $('#btnCalc').addEventListener('click', () => {
                // --- CREDIT CHECK FOR CALC METRICS ---
                // if (!useCredit()) {
                //     return; // Stop if no credits
                // }
                // --- END CREDIT CHECK ---
                updateCards();
            });


            $('#buy-credits-link').addEventListener('click', (e) => {
                e.preventDefault(); // Stop the link from trying to go anywhere
                openPaymentPopup(); // Call our new payment function
            });

            $('#save-view').addEventListener('click', saveView);
            $('#load-view').addEventListener('change', loadView);
            // ---

            // --- ADD THIS NEW LISTENER ---
            $('#calc-running-total').addEventListener('click', calculateRunningTotal);


            // This dropdown also calls drawMain, which has the credit check
            $$('#u-type, #u-metric').forEach(el => el.addEventListener('change', drawMain));

            // These are free chart updates
            $$('#st-type, #st-metric').forEach(el => el.addEventListener('change', drawSalesTrend));
            $$('#pt-type, #pt-metric').forEach(el => el.addEventListener('change', drawProfitTrend));
            $$('#ovl-type-a, #ovl-type-b').forEach(el => el.addEventListener('change', drawOverlay));
            $('#sc-refresh').addEventListener('click', drawScatter);
            $$('.card-metric-select, .card-agg-select').forEach(el => el.addEventListener('change', updateCards));

            // --- Load Default Data ---
            const defaultCSV = `Date,Region,Product,Sales,Profit,Units_Sold`;
            parseCSV(defaultCSV);
            refreshAll(); // <-- This runs on page load (no credits charged yet)
        })();
    </script>
</body>

</html>